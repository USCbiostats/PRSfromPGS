# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

PRSfromPGS calculates Polygenic Risk Scores (PRS) from genetic data. It reads genotype dosage data from bgzipped VCF files and applies PGS Catalog-format scoring models to produce per-sample risk scores. The project is structured as a standard R package.

## Building and Checking

```r
devtools::document()   # regenerate NAMESPACE and man/ pages after editing roxygen2 comments
devtools::check()      # run R CMD check (includes building and testing)
devtools::load_all()   # load package for interactive development
devtools::install()    # install the package locally
```

There is no test suite yet.

## Architecture

The package has two main source files in `R/` with a clear separation of concerns:

### R/readvcf.R — VCF I/O Layer
Handles all interaction with bgzipped VCF files via Bioconductor's `VariantAnnotation` and `Rsamtools`. Key flow:

1. `create_tabix_files()` — indexes VCF files for random access
2. `getsnpinfo()` / `summarizesnpinfo()` — reads variant metadata (no genotypes) into a data frame
3. `summarizevcf()` — produces a summary list (file path, genome, SNP data frame + rowRanges, sample IDs)
4. `getvcfsnp()` — reads DS (dosage) genotype values for specific SNP indices from a VCF summary
5. `prepareVCFfiles()` — batch-processes multiple VCF files, saving per-chromosome RDS summaries as `chromosome{N}VCFsummary.rds`

### R/calculatePRS.R — Scoring Layer
Reads PGS models and computes scores. Key flow:

1. `readPGSmodel()` — parses PGS Catalog TSV files; normalizes column names (`hm_chr`→`chr_name`, `hm_pos`→`chr_position`, `hm_inferOtherAllele`→`other_allele`); creates composite `chr:pos:ea:oa` IDs when rsIDs are missing
2. `findSNPs()` — matches PGS model variants to VCF variants using `data.table` joins on position + allele; returns separate REF and ALT match lists
3. `calculatePRSalt()` / `calculatePRSref()` — compute weighted dosage sums; REF path uses `(2 - dosage)` to get effect allele dosage
4. `calculatePRS()` — iterates chromosomes 1–22 (via `processSingleChromosome()`), sums per-chromosome PRS into final scores
5. `fitPRSmodels()` — efficiently scores multiple models by reading each chromosome's VCF data once (via `processChromosomeForModels()`)

### Data Flow
```
VCF files (.vcf.gz) → prepareVCFfiles() → chromosome{N}VCFsummary.rds
PGS model file (.txt) → readPGSmodel() → data frame
                         ↓
                    findSNPs() matches variants by position + allele
                         ↓
              calculatePRSalt() + calculatePRSref()
                         ↓
                    calculatePRS() sums across chromosomes → named numeric vector
```

## Key Design Decisions

- **Chromosome-based organization**: VCF summaries are saved/loaded per chromosome as RDS files. Functions expect `chromosome{N}VCFsummary.rds` in the working directory.
- **Separate REF/ALT scoring paths**: When the effect allele matches REF, dosage is complemented (`2 - DS`); when it matches ALT, DS is used directly.
- **Batch VCF reading**: `getvcfsnp()` reads dosages in configurable batches (`batch_size`, default 1000) to control memory.
- **Parallel processing**: Uses `future`/`future.apply` for chromosome-level parallelism. Platform-aware: `multicore` (fork) on Unix, `multisession` on Windows. Uses `BiocParallel` for VCF indexing parallelism. All parallel packages are optional with graceful fallback.

## Dependencies

**Required**: `VariantAnnotation`, `Rsamtools` (Bioconductor), `data.table` (CRAN)

**Optional** (for parallelism): `BiocParallel` (Bioconductor), `future`, `future.apply`, `parallelly` (CRAN)

## Package Structure

```
PRSfromPGS/
  DESCRIPTION          # package metadata and dependencies
  NAMESPACE            # auto-generated by roxygen2 (do not edit by hand)
  LICENSE              # MIT license file
  .Rbuildignore        # files excluded from R CMD build
  R/
    PRSfromPGS-package.R  # package-level docs + centralized imports
    readvcf.R             # VCF I/O layer (7 exported functions)
    calculatePRS.R        # scoring layer (6 exported + 2 internal functions)
  man/                    # auto-generated by roxygen2 (do not edit by hand)
```

## Conventions

- All public functions use roxygen2 `#'` documentation with `@param`, `@return`, and `@examples`
- Internal helpers are tagged `@keywords internal`
- Exported functions are tagged `@export`; NAMESPACE is managed by roxygen2
- Imports are centralized in `R/PRSfromPGS-package.R` — never use `library()` or `source()` in R files
- Most functions accept `verbose = TRUE` for progress logging via `message()`
- File I/O is wrapped in `tryCatch()` with informative `stop()` / `warning()` messages
- `data.table` is used for all variant matching joins (never base R merge)
